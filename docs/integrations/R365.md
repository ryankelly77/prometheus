# Restaurant365 (R365) Integration

> **Status:** In Development
> **Last Updated:** 2026-02-24

## Overview

Restaurant365 provides two API interfaces for data access:

1. **R365 API Connector** - Traditional REST API with JWT authentication (read/write)
2. **OData Connector** - OData-based API for read access with near real-time data

We use the **OData Connector** for pulling operational data (labor, sales, costs) and the **REST API** for authentication and any write operations.

## API Access

To access R365 APIs:
1. Customer contacts R365 Support to request API access
2. R365 provides API credentials (username/password) to the integration partner
3. Credentials are used to obtain a JWT bearer token

**Contact:** support@restaurant365.net

## Authentication

### JWT Bearer Token

```
POST https://[CUSTOMER-URL].restaurant365.com/APIv1/Authenticate/JWT?format=json
Content-Type: application/json

{
  "username": "api_user@example.com",
  "password": "api_password"
}
```

**Response:**
```json
{
  "SessionId": "abc123...",
  "UserName": "api_user@example.com",
  "BearerToken": "eyJhbGciOiJIUzI1NiIs..."
}
```

The bearer token is included in all subsequent requests:
```
Authorization: Bearer eyJhbGciOiJIUzI1NiIs...
```

### Token Lifecycle
- Token expiration: Not documented (assumed 24 hours, refresh as needed)
- Refresh: Re-authenticate with credentials
- Storage: Encrypted in `Integration.accessToken`

## OData Connector

### Base URL
```
https://odata.restaurant365.net/api/v2/views/
```

### Metadata
Full schema available at:
```
https://odata.restaurant365.net/api/v2/views/$metadata
```

### Available Views (Endpoints)

| View | Description | Prometheus Mapping |
|------|-------------|-------------------|
| `LaborDetail` | Labor hours by employee/position | `LaborDetail` |
| `Employee` | Employee master data | Reference |
| `JobTitle` | Job title definitions | `PositionCategory` mapping |
| `POSEmployee` | POS employee records | Reference |
| `SalesEmployee` | Sales by employee | `DailyMetrics` |
| `Transaction` | AP/AR transactions | `TransactionSummary` |
| `TransactionDetail` | Line-item details | Cost breakdown |
| `GLAccount` | Chart of accounts | Reference |
| `Location` | Location master data | Location mapping |
| `Company` | Company/entity data | Organization mapping |

### Query Examples

**Labor Detail with Filters:**
```
GET https://odata.restaurant365.net/api/v2/views/LaborDetail
  ?$filter=dateWorked ge 2026-01-01 and dateWorked le 2026-01-31
  &$select=dateWorked,employee_Id,jobTitle_Id,hours,laborCost
  &$orderby=dateWorked
```

**Join Labor to Job Title:**
```
GET https://odata.restaurant365.net/api/v2/views/LaborDetail
  ?$expand=JobTitle
  &$filter=dateWorked ge 2026-01-01
```

### Pagination

OData standard pagination:
- `$top=100` - Limit results
- `$skip=100` - Skip records for pagination
- Response includes `@odata.nextLink` for next page

### Date Range Limits

> **IMPORTANT:** Sales queries are limited to a **31-day range** per request.

For historical pulls exceeding 31 days, batch requests by month:
```typescript
// Example: 12-month pull = 12 separate requests
for (let month = 0; month < 12; month++) {
  const start = startOfMonth(subMonths(now, month));
  const end = endOfMonth(subMonths(now, month));
  await fetchLaborData(start, end);
}
```

## Data Availability

| Data Type | Availability |
|-----------|-------------|
| Labor (scheduled) | Near real-time |
| Labor (actual) | After Daily Sales Summary |
| Sales | After Daily Sales Summary |
| AP Invoices | Near real-time |
| GL Transactions | Near real-time |

> Sales and labor data captured by intraday polling is **not** available via OData. This data becomes available only after the Daily Sales Summary is polled (typically overnight).

## Rate Limits

Not explicitly documented. Recommended approach:
- **Concurrent requests:** Max 2 parallel
- **Requests per minute:** 60 (conservative)
- **Backoff:** Exponential on 429 errors
- **Batch size:** 100-500 records per request

## Field Mappings

### R365 LaborDetail â†’ Prometheus LaborDetail

| R365 Field | Prometheus Field |
|------------|------------------|
| `dateWorked` | `date` |
| `jobTitle.name` | `positionName` |
| (derived) | `positionCategory` (FOH/BOH) |
| `scheduledHours` | `hoursScheduled` |
| `hours` | `hoursWorked` |
| `overtimeHours` | `overtimeHours` |
| `laborCost` | `laborCost` |
| `laborCost / hours` | `avgHourlyRate` |
| (count distinct) | `employeeCount` |

### Position Category Mapping

```typescript
function categorizePosition(jobTitle: string): 'FOH' | 'BOH' {
  const bohKeywords = [
    'cook', 'chef', 'prep', 'dish', 'kitchen',
    'line', 'grill', 'fry', 'pantry', 'garde'
  ];
  return bohKeywords.some(k =>
    jobTitle.toLowerCase().includes(k)
  ) ? 'BOH' : 'FOH';
}
```

## Location Mapping

R365 uses its own location IDs. During setup, user maps R365 locations to Prometheus locations:

```json
// Integration.config
{
  "locationMappings": {
    "r365-loc-12345": "prometheus-loc-abc",
    "r365-loc-67890": "prometheus-loc-def"
  },
  "r365CustomerUrl": "acme.restaurant365.com"
}
```

## Error Handling

| HTTP Status | Meaning | Action |
|-------------|---------|--------|
| 401 | Unauthorized | Re-authenticate, get new token |
| 403 | Forbidden | Check permissions, contact R365 support |
| 404 | Not found | Verify endpoint/resource exists |
| 429 | Rate limited | Exponential backoff |
| 500 | Server error | Retry with backoff, log for support |

## Sync Strategy

### Initial Sync (on connect)
1. Authenticate, store encrypted token
2. Fetch R365 locations, prompt user to map
3. Pull last 30 days of data (default)
4. Optionally offer "Import Historical Data" (up to 12 months)

### Incremental Sync (scheduled)
1. Daily at 6 AM (after Daily Sales Summary)
2. Pull previous day's data
3. Update warehouse tables

### Full Historical Sync (on-demand)
1. User triggers from Settings
2. Pull 12 months in 31-day batches
3. Show progress (0-100%)
4. Background processing recommended

## Testing

### Sandbox Environment
R365 does not provide a public sandbox. For development:
- Use mock responses based on documented schemas
- Request test credentials from R365 for integration partners
- Use production credentials against a test R365 database if available

### Mock Data Structure
See `src/lib/integrations/r365/__mocks__/` for mock responses.

## References

- [R365 API Connector Documentation](https://docs.restaurant365.com/docs/r365-api-connector)
- [R365 OData Connector Documentation](https://docs.restaurant365.com/docs/restaurant365-odata-connector)
- [R365 Support Center - API](https://help.restaurant365.net/support/solutions/folders/12000010205)
- [Connecting OData via Excel](https://docs.restaurant365.com/docs/connecting-to-the-odata-connector-via-excel)
