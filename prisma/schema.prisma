generator client {
  provider = "prisma-client-js"
  output   = "../src/generated/prisma"
}

datasource db {
  provider = "postgresql"
}

model Organization {
  id                String              @id @default(cuid())
  name              String
  slug              String              @unique
  logoUrl           String?
  logoIconUrl       String?
  faviconUrl        String?
  primaryColor      String              @default("#6366f1")
  primaryTextLight  Boolean             @default(true)
  accentColor       String              @default("#8b5cf6")
  accentTextLight   Boolean             @default(true)
  darkMode          Boolean             @default(true)
  customDomain      String?             @unique
  domainVerified    Boolean             @default(false)
  domainVerifyToken String?
  ssoEnabled        Boolean             @default(false)
  ssoProvider       SSOProvider?
  ssoEntityId       String?
  ssoMetadataUrl    String?
  ssoClientId       String?
  ssoClientSecret   String?
  ssoTenantId       String?
  ssoDomain         String?
  allowPublicSignup Boolean             @default(false)
  requireSso        Boolean             @default(false)
  plan              PlanType            @default(STARTER)
  planSeats         Int                 @default(5)
  planLocations     Int                 @default(1)
  trialEndsAt       DateTime?
  createdAt         DateTime            @default(now())
  updatedAt         DateTime            @updatedAt
  aiPrompts         AIPrompt[]
  aiUsage           AIUsage[]
  apiLogs           ApiLog[]
  integrationStatus IntegrationStatus[]
  invitations       Invitation[]
  restaurantGroups  RestaurantGroup[]
  ssoSessions       SSOSession[]
  userOrganizations UserOrganization[]

  @@index([slug])
}

model RestaurantGroup {
  id             String       @id @default(cuid())
  organizationId String
  name           String
  createdAt      DateTime     @default(now())
  updatedAt      DateTime     @updatedAt
  locations      Location[]
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@index([organizationId])
}

model Location {
  id                  String               @id @default(cuid())
  restaurantGroupId   String
  name                String
  neighborhood        String?              // e.g., "Pearl", "The Rim", "Downtown"
  address             String?
  city                String?
  state               String?
  zipCode             String?
  latitude            Float?
  longitude           Float?
  timezone            String               @default("America/Chicago")
  conceptType         String?
  restaurantType      String?              // fine_dining, casual_dining, fast_casual, quick_service, cafe, bar_pub, bistro, ethnic_specialty, food_truck, buffet, family_style, ghost_kitchen
  isActive            Boolean              @default(true)
  isDefault           Boolean              @default(false)

  // Data source connection flags (for intelligence confidence calculation)
  // These are set explicitly when a user connects an integration, not inferred from data
  salesEnabled        Boolean              @default(false)  // POS/Toast connected
  weatherEnabled      Boolean              @default(false)  // Weather intelligence enabled
  costsEnabled        Boolean              @default(false)  // Accounting integration (QuickBooks/Xero/R365)
  eventsEnabled       Boolean              @default(false)  // Local events feed connected
  customersEnabled    Boolean              @default(false)  // Reservations/CRM connected (OpenTable, Resy)
  reviewsEnabled      Boolean              @default(false)  // Review aggregation connected
  visibilityEnabled   Boolean              @default(false)  // SEO/visibility tracking connected

  createdAt           DateTime             @default(now())
  updatedAt           DateTime             @updatedAt
  aiInsights          AIInsight[]
  apiLogs             ApiLog[]
  categorySales       CategorySales[]
  customerLoyalty     CustomerLoyalty[]
  dailyMetrics        DailyMetrics[]
  daypartMetrics      DaypartMetrics[]
  healthScoreConfig   HealthScoreConfig?
  healthScoreHistory  HealthScoreHistory[]
  insightCaches       InsightCache[]
  integrations        Integration[]
  laborDetails        LaborDetail[]
  localEvents         LocalEvent[]
  restaurantGroup     RestaurantGroup      @relation(fields: [restaurantGroupId], references: [id], onDelete: Cascade)
  menuCategories      MenuCategory[]
  menuItems           MenuItem[]
  menuItemSales       MenuItemSales[]
  monthlyMetrics      MonthlyMetrics[]
  prMentions          PRMention[]
  reviews             Review[]
  reviewMetrics       ReviewMetrics[]
  seatingAreas        SeatingArea[]
  socialAccounts      SocialAccount[]
  transactionSummary  TransactionSummary[]
  weatherData         WeatherData[]
  websiteVisibility   WebsiteVisibility[]
  restaurantProfile   RestaurantProfile?
  insightFeedback     InsightFeedback[]
  dailyBriefings      DailyBriefing[]
  revenueCenterMetrics RevenueCenterMetrics[]

  @@index([restaurantGroupId])
}

// Restaurant Intelligence Profile - stores profile data and AI context for insights
model RestaurantProfile {
  id                   String    @id @default(cuid())
  locationId           String    @unique
  restaurantType       String?   @db.VarChar(50)  // 'fine_dining', 'casual_dining', etc.
  conceptDescription   String?   @db.Text         // free text, e.g. "French brasserie"
  cuisineType          String?   @db.VarChar(100) // "French-inspired", "Italian", etc.
  priceRange           String?   @db.VarChar(20)  // "$", "$$", "$$$", "$$$$"
  seatingCapacity      Int?
  neighborhood         String?   @db.VarChar(200)
  targetDemographic    String?   @db.Text
  selectedDescriptors  String[]  // array of descriptor IDs for UI state
  userContext          String[]  // array of context strings for AI prompt
  dataFacts            Json      @default("{}")   // auto-calculated from POS data
  factsUpdatedAt       DateTime?
  createdAt            DateTime  @default(now())
  updatedAt            DateTime  @updatedAt
  location             Location  @relation(fields: [locationId], references: [id], onDelete: Cascade)

  @@index([locationId])
}

// Insight Feedback - stores user ratings/feedback on AI insights
model InsightFeedback {
  id            String    @id @default(cuid())
  locationId    String
  insightId     String
  rating        String    @db.VarChar(20)  // 'helpful', 'not_helpful', 'incorrect'
  userComment   String?   @db.Text
  createdAt     DateTime  @default(now())
  location      Location  @relation(fields: [locationId], references: [id], onDelete: Cascade)
  insight       AIInsight @relation(fields: [insightId], references: [id], onDelete: Cascade)

  @@index([locationId])
  @@index([insightId])
}

model UserProfile {
  id                    String               @id
  email                 String               @unique
  fullName              String?
  avatarUrl             String?
  ssoProviderId         String?
  createdAt             DateTime             @default(now())
  updatedAt             DateTime             @updatedAt
  aiInsightsGenerated   AIInsight[]
  integrationsConnected Integration[]
  localEventsCreated    LocalEvent[]
  prMentionsCreated     PRMention[]
  passwordResetTokens   PasswordResetToken[]
  userOrganizations     UserOrganization[]

  @@index([email])
}

model PasswordResetToken {
  id        String      @id @default(cuid())
  userId    String
  token     String      @unique @default(cuid())
  expiresAt DateTime
  usedAt    DateTime?
  createdAt DateTime    @default(now())
  user      UserProfile @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([token])
  @@index([userId])
}

model UserOrganization {
  id                 String       @id @default(cuid())
  userId             String
  organizationId     String
  role               UserRole
  restaurantGroupIds String[]     @default([])
  locationIds        String[]     @default([])
  isActive           Boolean      @default(true)
  lastAccessAt       DateTime?
  createdAt          DateTime     @default(now())
  updatedAt          DateTime     @updatedAt
  organization       Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  user               UserProfile  @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, organizationId])
  @@index([organizationId])
  @@index([userId])
}

model Invitation {
  id                 String       @id @default(cuid())
  organizationId     String
  email              String
  role               UserRole
  restaurantGroupIds String[]     @default([])
  locationIds        String[]     @default([])
  token              String       @unique @default(cuid())
  expiresAt          DateTime
  acceptedAt         DateTime?
  revokedAt          DateTime?
  invitedById        String
  invitedByEmail     String
  emailSentAt        DateTime?
  emailSentCount     Int          @default(0)
  createdAt          DateTime     @default(now())
  organization       Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@unique([organizationId, email])
  @@index([token])
  @@index([organizationId])
}

model SSOSession {
  id             String       @id @default(cuid())
  organizationId String
  state          String       @unique
  nonce          String?
  redirectUrl    String?
  expiresAt      DateTime
  usedAt         DateTime?
  createdAt      DateTime     @default(now())
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@index([state])
}

model DaypartMetrics {
  id                   String   @id @default(cuid())
  locationId           String
  date                 DateTime @db.Date
  daypart              Daypart
  totalSales           Decimal  @default(0) @db.Decimal(12, 2)
  foodSales            Decimal  @default(0) @db.Decimal(12, 2)
  beverageSales        Decimal  @default(0) @db.Decimal(12, 2)
  alcoholSales         Decimal  @default(0) @db.Decimal(12, 2)
  beerSales            Decimal  @default(0) @db.Decimal(12, 2)
  wineSales            Decimal  @default(0) @db.Decimal(12, 2)
  liquorSales          Decimal  @default(0) @db.Decimal(12, 2)
  nonAlcoholicBevSales Decimal  @default(0) @db.Decimal(12, 2)
  covers               Int      @default(0)
  checkCount           Int      @default(0)
  fohLaborHours        Decimal  @default(0) @db.Decimal(8, 2)
  fohLaborCost         Decimal  @default(0) @db.Decimal(12, 2)
  bohLaborHours        Decimal  @default(0) @db.Decimal(8, 2)
  bohLaborCost         Decimal  @default(0) @db.Decimal(12, 2)
  laborHours           Decimal  @default(0) @db.Decimal(8, 2)
  laborCost            Decimal  @default(0) @db.Decimal(12, 2)
  ppa                  Decimal? @db.Decimal(10, 2)
  createdAt            DateTime @default(now())
  updatedAt            DateTime @updatedAt
  location             Location @relation(fields: [locationId], references: [id], onDelete: Cascade)

  @@unique([locationId, date, daypart])
  @@index([locationId, date])
}

model DailyMetrics {
  id                   String       @id @default(cuid())
  locationId           String
  date                 DateTime     @db.Date
  dayOfWeek            Int
  totalSales           Decimal      @default(0) @db.Decimal(12, 2)
  foodSales            Decimal      @default(0) @db.Decimal(12, 2)
  beverageSales        Decimal      @default(0) @db.Decimal(12, 2)
  alcoholSales         Decimal      @default(0) @db.Decimal(12, 2)
  beerSales            Decimal      @default(0) @db.Decimal(12, 2)
  wineSales            Decimal      @default(0) @db.Decimal(12, 2)
  liquorSales          Decimal      @default(0) @db.Decimal(12, 2)
  nonAlcoholicBevSales Decimal      @default(0) @db.Decimal(12, 2)
  covers               Int          @default(0)
  checkCount           Int          @default(0)
  reservationCovers    Int          @default(0)
  walkInCovers         Int          @default(0)
  noShows              Int          @default(0)
  fohLaborHours        Decimal      @default(0) @db.Decimal(8, 2)
  fohLaborCost         Decimal      @default(0) @db.Decimal(12, 2)
  bohLaborHours        Decimal      @default(0) @db.Decimal(8, 2)
  bohLaborCost         Decimal      @default(0) @db.Decimal(12, 2)
  laborHours           Decimal      @default(0) @db.Decimal(8, 2)
  laborCost            Decimal      @default(0) @db.Decimal(12, 2)
  foodCost             Decimal?     @db.Decimal(12, 2)
  ppa                  Decimal?     @db.Decimal(10, 2)
  laborPercent         Decimal?     @db.Decimal(5, 2)
  weatherId            String?
  eventsContext        Json?
  createdAt            DateTime     @default(now())
  updatedAt            DateTime     @updatedAt
  location             Location     @relation(fields: [locationId], references: [id], onDelete: Cascade)
  weather              WeatherData? @relation(fields: [weatherId], references: [id])

  @@unique([locationId, date])
  @@index([locationId, date])
  @@index([date])
}

model MonthlyMetrics {
  id                   String   @id @default(cuid())
  locationId           String
  month                DateTime
  totalSales           Decimal? @db.Decimal(12, 2)
  foodSales            Decimal? @db.Decimal(12, 2)
  beverageSales        Decimal? @db.Decimal(12, 2)
  alcoholSales         Decimal? @db.Decimal(12, 2)
  beerSales            Decimal? @db.Decimal(12, 2)
  wineSales            Decimal? @db.Decimal(12, 2)
  liquorSales          Decimal? @db.Decimal(12, 2)
  nonAlcoholicBevSales Decimal? @db.Decimal(12, 2)
  totalCovers          Int?
  reservationCovers    Int?
  walkInCovers         Int?
  totalNoShows         Int?
  fohLaborHours        Decimal? @db.Decimal(10, 2)
  fohLaborCost         Decimal? @db.Decimal(12, 2)
  bohLaborHours        Decimal? @db.Decimal(10, 2)
  bohLaborCost         Decimal? @db.Decimal(12, 2)
  laborHours           Decimal? @db.Decimal(10, 2)
  laborCost            Decimal? @db.Decimal(12, 2)
  foodCost             Decimal? @db.Decimal(12, 2)
  ppa                  Decimal? @db.Decimal(10, 2)
  primeCost            Decimal? @db.Decimal(5, 2)
  laborPercent         Decimal? @db.Decimal(5, 2)
  foodPercent          Decimal? @db.Decimal(5, 2)
  revPash              Decimal? @db.Decimal(10, 2)
  operatingDays        Int?
  targets              Json?
  createdAt            DateTime @default(now())
  updatedAt            DateTime @updatedAt
  location             Location @relation(fields: [locationId], references: [id], onDelete: Cascade)

  @@unique([locationId, month])
  @@index([locationId])
  @@index([month])
}

model CustomerLoyalty {
  id               String   @id @default(cuid())
  locationId       String
  month            DateTime
  oneVisit         Int      @default(0)
  twoToFourVisits  Int      @default(0)
  fiveToNineVisits Int      @default(0)
  tenPlusVisits    Int      @default(0)
  uniqueCustomers  Int      @default(0)
  repeatRate       Decimal? @db.Decimal(5, 2)
  loyaltyRate      Decimal? @db.Decimal(5, 2)
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt
  location         Location @relation(fields: [locationId], references: [id], onDelete: Cascade)

  @@unique([locationId, month])
  @@index([locationId])
}

model Review {
  id             String          @id @default(cuid())
  locationId     String
  platform       ReviewPlatform
  externalId     String?
  externalUrl    String?
  rating         Int
  reviewText     String?
  reviewerName   String?
  reviewerUrl    String?
  reviewDate     DateTime
  responseText   String?
  responseDate   DateTime?
  sentimentScore Decimal?        @db.Decimal(3, 2)
  sentimentLabel SentimentLabel?
  keywords       String[]
  syncedAt       DateTime        @default(now())
  createdAt      DateTime        @default(now())
  updatedAt      DateTime        @updatedAt
  location       Location        @relation(fields: [locationId], references: [id], onDelete: Cascade)

  @@unique([locationId, platform, externalId])
  @@index([locationId, reviewDate])
  @@index([locationId, platform])
  @@index([rating])
}

model ReviewMetrics {
  id                   String   @id @default(cuid())
  locationId           String
  month                DateTime
  totalReviews         Int      @default(0)
  newReviews           Int      @default(0)
  oneStarCount         Int      @default(0)
  twoStarCount         Int      @default(0)
  threeStarCount       Int      @default(0)
  fourStarCount        Int      @default(0)
  fiveStarCount        Int      @default(0)
  averageRating        Decimal? @db.Decimal(3, 2)
  cumulativeRating     Decimal? @db.Decimal(3, 2)
  responseCount        Int      @default(0)
  responseRate         Decimal? @db.Decimal(5, 2)
  avgResponseTimeHours Int?
  positiveCount        Int      @default(0)
  neutralCount         Int      @default(0)
  negativeCount        Int      @default(0)
  platformBreakdown    Json?
  createdAt            DateTime @default(now())
  updatedAt            DateTime @updatedAt
  location             Location @relation(fields: [locationId], references: [id], onDelete: Cascade)

  @@unique([locationId, month])
  @@index([locationId])
}

model WebsiteVisibility {
  id                String   @id @default(cuid())
  locationId        String
  month             DateTime
  visibilityScore   Decimal? @db.Decimal(5, 2)
  organicKeywords   Int?
  organicTraffic    Int?
  localPackRankings Json?
  avgLocalRank      Decimal? @db.Decimal(4, 1)
  trackedKeywords   Json?
  gbpImpressions    Int?
  gbpClicks         Int?
  gbpCalls          Int?
  gbpDirections     Int?
  aiVisibility      Json?
  aiMentionCount    Int?
  aiPlatforms       String[]
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt
  location          Location @relation(fields: [locationId], references: [id], onDelete: Cascade)

  @@unique([locationId, month])
  @@index([locationId])
}

model PRMention {
  id          String          @id @default(cuid())
  locationId  String
  mentionDate DateTime        @db.Date
  month       DateTime
  outlet      String
  title       String?
  url         String?
  mentionType MentionType
  reach       Int?
  sentiment   SentimentLabel?
  enteredById String?
  notes       String?
  createdAt   DateTime        @default(now())
  updatedAt   DateTime        @updatedAt
  enteredBy   UserProfile?    @relation(fields: [enteredById], references: [id])
  location    Location        @relation(fields: [locationId], references: [id], onDelete: Cascade)

  @@index([locationId, month])
  @@index([locationId, mentionDate])
}

model HealthScoreConfig {
  id                  String   @id @default(cuid())
  locationId          String   @unique
  weights             Json
  targets             Json
  metricDirections    Json?
  ebitdaTarget        Decimal? @db.Decimal(12, 2)
  ebitdaBonusPoints   Decimal? @db.Decimal(5, 2)
  ebitdaPenaltyPoints Decimal? @db.Decimal(5, 2)
  thresholds          Json?
  createdAt           DateTime @default(now())
  updatedAt           DateTime @updatedAt
  location            Location @relation(fields: [locationId], references: [id], onDelete: Cascade)
}

model HealthScoreHistory {
  id               String       @id @default(cuid())
  locationId       String
  month            DateTime
  overallScore     Decimal      @db.Decimal(6, 2)
  metricScores     Json
  baseScore        Decimal      @db.Decimal(6, 2)
  ebitdaActual     Decimal?     @db.Decimal(12, 2)
  ebitdaAdjustment Decimal?     @db.Decimal(5, 2)
  previousScore    Decimal?     @db.Decimal(6, 2)
  scoreDelta       Decimal?     @db.Decimal(5, 2)
  trend            Trend?
  status           HealthStatus
  configSnapshot   Json?
  calculatedAt     DateTime     @default(now())
  location         Location     @relation(fields: [locationId], references: [id], onDelete: Cascade)

  @@unique([locationId, month])
  @@index([locationId])
  @@index([month])
}

model WeatherData {
  id            String            @id @default(cuid())
  locationId    String
  date          DateTime          @db.Date

  // Temperature (Fahrenheit)
  tempHigh      Float?
  tempLow       Float?
  tempAvg       Float?
  feelsLikeHigh Float?
  feelsLikeLow  Float?

  // Precipitation (inches)
  precipitation      Float?            // Total for the day (inches)
  precipProb         Float?            // Probability 0-100
  precipitationHours Int?              // Hours with precipitation
  rainInches         Float?            // Rain only (excludes snow)
  snowfall           Float?            // Snowfall inches

  // Conditions
  weatherCode        Int?              // WMO weather code from Open-Meteo
  condition          WeatherCondition?
  weatherDescription String?           // Human readable: "Clear", "Rain", etc.

  // Wind (mph)
  windSpeed     Float?
  windSpeedMax  Float?                // Max wind speed for the day
  windGusts     Float?

  // Other
  humidity      Float?
  cloudCover    Float?
  uvIndex       Float?

  // Derived flags (useful for quick queries)
  isRainy         Boolean  @default(false)  // precipitation > 0.1 inches
  isExtremeHeat   Boolean  @default(false)  // tempHigh > 95
  isExtremeCold   Boolean  @default(false)  // tempLow < 32
  isSevereWeather Boolean  @default(false)  // thunderstorm, ice, heavy snow

  // Metadata
  isActual      Boolean           @default(false)
  forecastedAt  DateTime?
  createdAt     DateTime          @default(now())
  updatedAt     DateTime          @updatedAt
  dailyMetrics  DailyMetrics[]
  location      Location          @relation(fields: [locationId], references: [id], onDelete: Cascade)

  @@unique([locationId, date])
  @@index([locationId, date])
}

model LocalEvent {
  id                 String        @id @default(cuid())
  locationId         String
  name               String
  description        String?
  date               DateTime      @db.Date
  startTime          DateTime?
  endTime            DateTime?
  isMultiDay         Boolean       @default(false)
  endDate            DateTime?     @db.Date
  venueName          String?
  venueAddress       String?
  venueLat           Float?
  venueLng           Float?
  distanceMiles      Float?
  category           EventCategory
  subcategory        String?
  expectedAttendance Int?
  venueCapacity      Int?
  popularityScore    Float?
  impactScore        Int?
  impactLevel        EventImpact?
  impactNote         String?       @db.Text  // Restaurant-specific impact note for AI context
  source             EventSource
  externalId         String?
  externalUrl        String?
  fingerprint        String?
  rawData            Json?         // Original API response (for SeatGeek events)
  isManual           Boolean       @default(false)
  enteredById        String?
  createdAt          DateTime      @default(now())
  updatedAt          DateTime      @updatedAt
  enteredBy          UserProfile?  @relation(fields: [enteredById], references: [id])
  location           Location      @relation(fields: [locationId], references: [id], onDelete: Cascade)

  @@unique([locationId, source, externalId])
  @@index([locationId, date])
  @@index([date])
  @@index([fingerprint])
  @@index([category])
}

model Holiday {
  id          String       @id @default(cuid())
  date        DateTime     @db.Date
  year        Int?
  name        String
  type        HolidayType
  impactLevel EventImpact?
  notes       String?
  isNational  Boolean      @default(true)
  region      String?
  createdAt   DateTime     @default(now())
  updatedAt   DateTime     @updatedAt

  @@unique([date, name])
  @@index([date])
  @@index([type])
}

model Integration {
  id                    String                      @id @default(cuid())
  locationId            String
  type                  IntegrationType
  status                IntegrationConnectionStatus @default(DISCONNECTED)
  accessToken           String?
  refreshToken          String?
  tokenExpiresAt        DateTime?
  tokenStatus           TokenStatus?
  tokenExpiresWarningAt DateTime?
  tokenRefreshAttempts  Int                         @default(0)
  tokenLastRefreshAt    DateTime?
  tokenRefreshError     String?
  apiKey                String?
  apiSecret             String?
  config                Json?
  externalId            String?
  externalName          String?
  syncEnabled           Boolean                     @default(true)
  lastSyncAt            DateTime?
  lastSyncStatus        SyncStatus?
  lastSyncError         String?
  nextScheduledSync     DateTime?
  connectedAt           DateTime?
  connectedById         String?
  // Onboarding state for progressive intelligence
  onboardingStep        Int?                        // Current step in onboarding wizard (1=connecting, 2=syncing, 3=insights, etc.)
  onboardingSyncedMonths Int                        @default(0) // Number of months synced during onboarding
  onboardingStartedAt   DateTime?                   // When onboarding was initiated
  onboardingCompletedAt DateTime?                   // When onboarding was completed (null = incomplete)
  createdAt             DateTime                    @default(now())
  updatedAt             DateTime                    @updatedAt
  connectedBy           UserProfile?                @relation(fields: [connectedById], references: [id])
  location              Location                    @relation(fields: [locationId], references: [id], onDelete: Cascade)
  socialAccounts        SocialAccount[]

  @@unique([locationId, type])
  @@index([locationId])
  @@index([type, status])
}

model IntegrationStatus {
  id                  String        @id @default(cuid())
  service             ApiService
  organizationId      String?
  status              ServiceHealth @default(HEALTHY)
  lastSuccessAt       DateTime?
  lastErrorAt         DateTime?
  lastErrorMessage    String?
  lastErrorCode       String?
  consecutiveFailures Int           @default(0)
  circuitState        CircuitState  @default(CLOSED)
  circuitOpenedAt     DateTime?
  circuitResetAt      DateTime?
  lastSyncAt          DateTime?
  lastSyncDuration    Int?
  nextSyncAt          DateTime?
  syncInProgress      Boolean       @default(false)
  mtdRequests         Int           @default(0)
  mtdCost             Decimal       @default(0) @db.Decimal(10, 4)
  mtdUnits            Int           @default(0)
  costResetAt         DateTime?
  rateLimitRemaining  Int?
  rateLimitResetAt    DateTime?
  createdAt           DateTime      @default(now())
  updatedAt           DateTime      @updatedAt
  organization        Organization? @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@unique([service, organizationId])
  @@index([service])
  @@index([status])
}

model ApiLog {
  id                String        @id @default(cuid())
  service           ApiService
  endpoint          String
  method            HttpMethod    @default(GET)
  organizationId    String?
  locationId        String?
  requestUrl        String
  requestBody       Json?
  requestHeaders    Json?
  status            ApiLogStatus
  httpStatus        Int?
  responseBody      Json?
  responseSizeBytes Int?
  errorMessage      String?
  errorCode         String?
  errorStack        String?
  latencyMs         Int?
  cost              Decimal?      @db.Decimal(10, 6)
  units             Int?
  attemptNumber     Int           @default(1)
  retryOfId         String?
  willRetry         Boolean       @default(false)
  traceId           String?
  createdAt         DateTime      @default(now())
  location          Location?     @relation(fields: [locationId], references: [id])
  organization      Organization? @relation(fields: [organizationId], references: [id])

  @@index([service, createdAt])
  @@index([organizationId, createdAt])
  @@index([locationId, createdAt])
  @@index([status, createdAt])
  @@index([traceId])
}

model SocialAccount {
  id                String               @id @default(cuid())
  locationId        String
  platform          SocialPlatform
  accountId         String
  accountName       String
  accountUrl        String?
  profileImageUrl   String?
  connectionType    SocialConnectionType
  isConnected       Boolean              @default(true)
  integrationId     String?
  managedAccountRef String?
  followers         Int?
  following         Int?
  createdAt         DateTime             @default(now())
  updatedAt         DateTime             @updatedAt
  integration       Integration?         @relation(fields: [integrationId], references: [id])
  location          Location             @relation(fields: [locationId], references: [id], onDelete: Cascade)
  metrics           SocialMetrics[]
  posts             SocialPost[]

  @@unique([locationId, platform, accountId])
  @@index([locationId])
  @@index([platform])
}

model SocialMetrics {
  id               String        @id @default(cuid())
  socialAccountId  String
  month            DateTime
  followersStart   Int?
  followersEnd     Int?
  followersGained  Int?
  followersLost    Int?
  netFollowers     Int?
  postsPublished   Int           @default(0)
  storiesPublished Int           @default(0)
  reelsPublished   Int           @default(0)
  totalImpressions Int           @default(0)
  totalReach       Int           @default(0)
  totalEngagements Int           @default(0)
  totalLikes       Int           @default(0)
  totalComments    Int           @default(0)
  totalShares      Int           @default(0)
  totalSaves       Int           @default(0)
  engagementRate   Decimal?      @db.Decimal(5, 2)
  reachRate        Decimal?      @db.Decimal(5, 2)
  totalVideoViews  Int?
  totalWatchTime   Int?
  avgWatchTime     Decimal?      @db.Decimal(8, 2)
  storyViews       Int?
  storyReplies     Int?
  storyExits       Int?
  profileVisits    Int?
  websiteClicks    Int?
  emailClicks      Int?
  callClicks       Int?
  directionClicks  Int?
  topPosts         Json?
  createdAt        DateTime      @default(now())
  updatedAt        DateTime      @updatedAt
  socialAccount    SocialAccount @relation(fields: [socialAccountId], references: [id], onDelete: Cascade)

  @@unique([socialAccountId, month])
  @@index([socialAccountId])
  @@index([month])
}

model SocialPost {
  id                  String           @id @default(cuid())
  socialAccountId     String
  externalId          String
  postUrl             String?
  postType            PostType
  caption             String?
  mediaUrls           String[]
  hashtags            String[]
  mentions            String[]
  publishedAt         DateTime
  impressions         Int              @default(0)
  reach               Int              @default(0)
  likes               Int              @default(0)
  comments            Int              @default(0)
  shares              Int              @default(0)
  saves               Int              @default(0)
  videoViews          Int?
  videoWatchTime      Int?
  videoCompletionRate Decimal?         @db.Decimal(5, 2)
  engagementRate      Decimal?         @db.Decimal(5, 2)
  performance         PostPerformance?
  lastSyncedAt        DateTime         @default(now())
  createdAt           DateTime         @default(now())
  updatedAt           DateTime         @updatedAt
  socialAccount       SocialAccount    @relation(fields: [socialAccountId], references: [id], onDelete: Cascade)

  @@unique([socialAccountId, externalId])
  @@index([socialAccountId, publishedAt])
  @@index([postType])
  @@index([performance])
}

model AIPrompt {
  id                 String           @id @default(cuid())
  organizationId     String?
  name               String
  slug               String
  description        String?
  systemPrompt       String
  userPromptTemplate String
  category           AIPromptCategory
  model              String           @default("claude-sonnet-4-5-20250929")
  maxTokens          Int              @default(1024)
  temperature        Decimal          @default(0.7) @db.Decimal(2, 1)
  isActive           Boolean          @default(true)
  requiresPro        Boolean          @default(false)
  version            Int              @default(1)
  previousVersionId  String?
  createdAt          DateTime         @default(now())
  updatedAt          DateTime         @updatedAt
  insights           AIInsight[]
  organization       Organization?    @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@unique([slug, organizationId])
  @@index([organizationId])
  @@index([category])
  @@index([isActive])
}

model AIInsight {
  id              String            @id @default(cuid())
  locationId      String
  promptId        String
  batchId         String?           // Groups insights from the same generation
  isCurrent       Boolean           @default(true) // Current batch vs historical
  layer           String?           @db.VarChar(50) // 'sales', 'weather', 'events', 'costs'
  status          String            @default("active") @db.VarChar(20) // 'active', 'pinned', 'stale', 'hidden', 'archived'
  insightType     String?           @db.VarChar(30) // 'trend', 'anomaly', 'opportunity', 'recommendation'
  periodType      InsightPeriod
  periodStart     DateTime
  periodEnd       DateTime
  inputData       Json
  title           String?
  headline        String?           // Short headline for the insight
  content         String
  detail          String?           @db.Text // Expanded explanation
  contentHtml     String?
  keyPoints       String[]
  metrics         Json?
  recommendations Json?
  impact          String?           @db.Text // Dollar estimate or impact description
  recommendation  String?           @db.Text // Specific actionable recommendation
  sentiment       InsightSentiment?
  urgency         InsightUrgency?
  triggerType     InsightTrigger?
  generatedById   String?
  isRead          Boolean           @default(false)
  readAt          DateTime?
  isBookmarked    Boolean           @default(false)
  isDismissed     Boolean           @default(false)
  feedbackRating  Int?
  feedbackNote    String?
  model           String
  promptVersion   Int
  tokensUsed      Int?
  latencyMs       Int?
  cost            Decimal?          @db.Decimal(10, 6)
  generatedAt     DateTime          @default(now())
  expiresAt       DateTime?
  createdAt       DateTime          @default(now())
  generatedBy     UserProfile?      @relation(fields: [generatedById], references: [id])
  location        Location          @relation(fields: [locationId], references: [id], onDelete: Cascade)
  prompt          AIPrompt          @relation(fields: [promptId], references: [id])
  feedback        InsightFeedback[]

  @@index([locationId, periodStart])
  @@index([locationId, generatedAt])
  @@index([locationId, isCurrent])
  @@index([locationId, batchId])
  @@index([locationId, layer, status])
  @@index([promptId])
  @@index([isRead, isDismissed])
}

model AIUsage {
  id                String       @id @default(cuid())
  organizationId    String
  month             DateTime
  insightsGenerated Int          @default(0)
  reviewResponses   Int          @default(0)
  customQueries     Int          @default(0)
  totalRuns         Int          @default(0)
  inputTokens       Int          @default(0)
  outputTokens      Int          @default(0)
  totalTokens       Int          @default(0)
  totalCost         Decimal      @default(0) @db.Decimal(10, 4)
  runsIncluded      Int
  runsRemaining     Int
  createdAt         DateTime     @default(now())
  updatedAt         DateTime     @updatedAt
  organization      Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@unique([organizationId, month])
  @@index([organizationId])
  @@index([month])
}

model DailyBriefing {
  id           String   @id @default(cuid())
  locationId   String
  briefingDate DateTime @db.Date
  alert        Json?    // { type, icon, headline, detail }
  opportunity  Json?    // { headline, detail, estimatedImpact }
  inputData    Json?    // The data sent to Claude for debugging
  model        String?  // Claude model used
  tokensUsed   Int?
  generatedAt  DateTime @default(now())
  location     Location @relation(fields: [locationId], references: [id], onDelete: Cascade)

  @@unique([locationId, briefingDate])
  @@index([locationId])
  @@index([briefingDate])
}

model DemoFeedback {
  id        String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  name      String
  email     String?
  page      String
  comment   String
  createdAt DateTime? @default(now()) @map("created_at") @db.Timestamptz(6)

  @@map("demo_feedback")
}

// =============================================================================
// OPERATIONAL WAREHOUSE TABLES (Phase 2b)
// Pre-aggregated data for AI analysis and reporting
// =============================================================================

model MenuCategory {
  id           String     @id @default(cuid())
  locationId   String
  externalId   String?    // Toast/R365 category ID
  name         String
  displayOrder Int        @default(0)
  createdAt    DateTime   @default(now())
  updatedAt    DateTime   @updatedAt
  location     Location   @relation(fields: [locationId], references: [id], onDelete: Cascade)
  menuItems    MenuItem[]

  @@unique([locationId, externalId])
  @@index([locationId])
}

model MenuItem {
  id             String          @id @default(cuid())
  locationId     String
  categoryId     String?
  externalId     String?         // Toast/R365 item ID
  name           String
  description    String?
  currentPrice   Decimal         @db.Decimal(10, 2)
  isActive       Boolean         @default(true)
  createdAt      DateTime        @default(now())
  updatedAt      DateTime        @updatedAt
  category       MenuCategory?   @relation(fields: [categoryId], references: [id])
  location       Location        @relation(fields: [locationId], references: [id], onDelete: Cascade)
  menuItemSales  MenuItemSales[]

  @@unique([locationId, externalId])
  @@index([locationId])
  @@index([categoryId])
}

model MenuItemSales {
  id                  String   @id @default(cuid())
  locationId          String
  menuItemId          String
  weekStartDate       DateTime @db.Date
  quantitySold        Int      @default(0)
  totalRevenue        Decimal  @default(0) @db.Decimal(12, 2)
  avgPrice            Decimal? @db.Decimal(10, 2)
  foodCostActual      Decimal? @db.Decimal(12, 2)
  foodCostTheoretical Decimal? @db.Decimal(12, 2)
  profitMargin        Decimal? @db.Decimal(5, 2)
  createdAt           DateTime @default(now())
  updatedAt           DateTime @updatedAt
  location            Location @relation(fields: [locationId], references: [id], onDelete: Cascade)
  menuItem            MenuItem @relation(fields: [menuItemId], references: [id], onDelete: Cascade)

  @@unique([locationId, menuItemId, weekStartDate])
  @@index([locationId, weekStartDate])
  @@index([menuItemId])
}

model LaborDetail {
  id               String           @id @default(cuid())
  locationId       String
  date             DateTime         @db.Date
  positionName     String           // e.g., "Server", "Line Cook", "Host"
  positionCategory PositionCategory // FOH or BOH
  hoursScheduled   Decimal          @default(0) @db.Decimal(8, 2)
  hoursWorked      Decimal          @default(0) @db.Decimal(8, 2)
  overtimeHours    Decimal          @default(0) @db.Decimal(8, 2)
  laborCost        Decimal          @default(0) @db.Decimal(12, 2)
  avgHourlyRate    Decimal?         @db.Decimal(8, 2)
  employeeCount    Int              @default(0)
  createdAt        DateTime         @default(now())
  updatedAt        DateTime         @updatedAt
  location         Location         @relation(fields: [locationId], references: [id], onDelete: Cascade)

  @@unique([locationId, date, positionName])
  @@index([locationId, date])
  @@index([positionCategory])
}

model TransactionSummary {
  id               String    @id @default(cuid())
  locationId       String
  date             DateTime  @db.Date
  grossSales       Decimal   @default(0) @db.Decimal(12, 2)
  discounts        Decimal   @default(0) @db.Decimal(12, 2)
  comps            Decimal   @default(0) @db.Decimal(12, 2)
  voids            Decimal   @default(0) @db.Decimal(12, 2)
  refunds          Decimal   @default(0) @db.Decimal(12, 2)
  netSales         Decimal   @default(0) @db.Decimal(12, 2)
  cashPayments     Decimal   @default(0) @db.Decimal(12, 2)
  cardPayments     Decimal   @default(0) @db.Decimal(12, 2)
  giftCardPayments Decimal   @default(0) @db.Decimal(12, 2)
  otherPayments    Decimal   @default(0) @db.Decimal(12, 2)
  avgCheckSize     Decimal?  @db.Decimal(10, 2)
  avgTip           Decimal?  @db.Decimal(10, 2)
  tipPercent       Decimal?  @db.Decimal(5, 2)
  transactionCount Int       @default(0)
  // Raw components for reconciliation (stored for debugging without re-syncing)
  serviceCharges   Decimal   @default(0) @db.Decimal(12, 2) // For reference - not subtracted from netSales
  deferredRevenue  Decimal   @default(0) @db.Decimal(12, 2) // Subtracted from netSales (gift cards, deposits)
  syncedAt         DateTime? // When this record was last synced from POS
  createdAt        DateTime  @default(now())
  updatedAt        DateTime  @updatedAt
  location         Location  @relation(fields: [locationId], references: [id], onDelete: Cascade)

  @@unique([locationId, date])
  @@index([locationId, date])
  @@index([locationId, syncedAt])
}

model RevenueCenterMetrics {
  id                 String   @id @default(cuid())
  locationId         String
  date               DateTime @db.Date
  revenueCenterGuid  String   @db.VarChar(50)
  revenueCenterName  String   @db.VarChar(100)
  netSales           Decimal  @default(0) @db.Decimal(12, 2)
  orderCount         Int      @default(0)
  checkCount         Int      @default(0)
  avgCheck           Decimal? @db.Decimal(10, 2)
  isOutdoor          Boolean  @default(false)
  createdAt          DateTime @default(now())
  updatedAt          DateTime @updatedAt
  location           Location @relation(fields: [locationId], references: [id], onDelete: Cascade)

  @@unique([locationId, date, revenueCenterGuid])
  @@index([locationId, date])
  @@index([locationId, isOutdoor])
}

model CategorySales {
  id             String   @id @default(cuid())
  locationId     String
  date           DateTime @db.Date
  categoryName   String   // e.g., "Appetizers", "Entrees", "Beer", "Wine"
  itemsSold      Int      @default(0)
  totalRevenue   Decimal  @default(0) @db.Decimal(12, 2)
  percentOfSales Decimal? @db.Decimal(5, 2)
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt
  location       Location @relation(fields: [locationId], references: [id], onDelete: Cascade)

  @@unique([locationId, date, categoryName])
  @@index([locationId, date])
  @@index([categoryName])
}

model InsightCache {
  id          String       @id @default(cuid())
  locationId  String
  periodType  InsightPeriod // DAILY, WEEKLY, MONTHLY
  periodStart DateTime     @db.Date
  periodEnd   DateTime     @db.Date
  cacheType   String       // e.g., "sales_summary", "labor_summary", "menu_performance"
  data        Json         // Pre-calculated metrics JSON blob
  generatedAt DateTime     @default(now())
  expiresAt   DateTime
  createdAt   DateTime     @default(now())
  updatedAt   DateTime     @updatedAt
  location    Location     @relation(fields: [locationId], references: [id], onDelete: Cascade)

  @@unique([locationId, periodType, periodStart, cacheType])
  @@index([locationId, cacheType])
  @@index([expiresAt])
}

model SeatingArea {
  id                String   @id @default(cuid())
  locationId        String
  name              String   // "Patio", "Main Dining", "Bar", "Private Room"
  seats             Int      @default(0)
  isOutdoor         Boolean  @default(false)
  weatherDependent  Boolean  @default(false)
  avgRevenuePerSeat Decimal? @db.Decimal(10, 2) // Calculated field
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt
  location          Location @relation(fields: [locationId], references: [id], onDelete: Cascade)

  @@unique([locationId, name])
  @@index([locationId])
}

enum PlanType {
  STARTER
  PRO
  ENTERPRISE
}

enum SSOProvider {
  SAML
  OIDC
  AZURE_AD
  OKTA
  GOOGLE_WORKSPACE
}

enum UserRole {
  SUPER_ADMIN
  PARTNER_ADMIN
  GROUP_ADMIN
  LOCATION_MANAGER
  VIEWER
}

enum Daypart {
  BREAKFAST
  BRUNCH
  LUNCH
  AFTERNOON
  DINNER
  LATE_NIGHT
}

enum PositionCategory {
  FOH
  BOH
}

enum Trend {
  UP
  DOWN
  FLAT
}

enum HealthStatus {
  EXCELLENT
  GOOD
  WARNING
  DANGER
}

enum ReviewPlatform {
  GOOGLE
  YELP
  TRIPADVISOR
  FACEBOOK
  OPENTABLE
  RESY
  OTHER
}

enum SentimentLabel {
  POSITIVE
  NEUTRAL
  NEGATIVE
  MIXED
}

enum MentionType {
  FEATURE_ARTICLE
  REVIEW
  AWARD
  BEST_OF_LIST
  NEWS_MENTION
  SOCIAL_INFLUENCER
  TV_RADIO
  OTHER
}

enum WeatherCondition {
  CLEAR
  MOSTLY_CLEAR
  PARTLY_CLOUDY
  OVERCAST
  FOGGY
  LIGHT_DRIZZLE
  DRIZZLE
  HEAVY_DRIZZLE
  LIGHT_RAIN
  RAIN
  HEAVY_RAIN
  LIGHT_SNOW
  SNOW
  HEAVY_SNOW
  SLEET
  THUNDERSTORM
  THUNDERSTORM_HAIL
}

enum EventCategory {
  SPORTS
  CONCERT
  THEATER
  COMEDY
  CONFERENCE
  CONVENTION
  FESTIVAL
  HOLIDAY
  SCHOOL_BREAK
  SCHOOL_EVENT
  COMMUNITY
  FOOD_DRINK
  PRIVATE_PARTY
  OTHER
}

enum EventSource {
  SEATGEEK
  TICKETMASTER
  EVENTBRITE
  SYSTEM
  MANUAL
  US_HOLIDAYS      // from /src/lib/data/holidays.ts
  SA_RECURRING     // SA local recurring events (Fiesta, Rodeo, etc.)
  SCHOOL_CALENDAR  // from /src/lib/data/school-calendar.ts
}

enum EventImpact {
  MINIMAL
  LOW
  MODERATE
  HIGH
  MAJOR
}

enum HolidayType {
  FEDERAL
  STATE
  RELIGIOUS
  CULTURAL
  COMMERCIAL
  LOCAL
  SCHOOL
}

enum IntegrationType {
  TOAST
  SQUARE
  CLOVER
  REVEL
  R365
  MARGINEDGE
  QUICKBOOKS
  OPENTABLE
  RESY
  TOCK
  YELP_RESERVATIONS
  GOOGLE_BUSINESS
  SPROUT_SOCIAL
  META_BUSINESS
}

enum IntegrationConnectionStatus {
  CONNECTED
  DISCONNECTED
  EXPIRED
  ERROR
  PENDING
}

enum SyncStatus {
  SUCCESS
  PARTIAL
  FAILED
  SKIPPED
}

enum TokenStatus {
  VALID
  EXPIRING_SOON
  EXPIRED
  REFRESH_FAILED
  NEEDS_REAUTH
}

enum ApiService {
  OPEN_METEO
  SEATGEEK
  TICKETMASTER
  EVENTBRITE
  BRIGHTLOCAL_REVIEWS
  BRIGHTLOCAL_LOCAL
  SEMRUSH
  METRICOOL
  TOAST
  SQUARE
  CLOVER
  REVEL
  R365
  MARGINEDGE
  QUICKBOOKS
  OPENTABLE
  RESY
  TOCK
  YELP_RESERVATIONS
  GOOGLE_BUSINESS
  SPROUT_SOCIAL
  META_BUSINESS
  CLAUDE_AI
  PROMETHEUS_AI_VISIBILITY
}

enum ServiceHealth {
  HEALTHY
  DEGRADED
  DOWN
  RATE_LIMITED
  MAINTENANCE
}

enum CircuitState {
  CLOSED
  OPEN
  HALF_OPEN
}

enum HttpMethod {
  GET
  POST
  PUT
  PATCH
  DELETE
}

enum ApiLogStatus {
  SUCCESS
  ERROR
  WARNING
  RATE_LIMITED
  TIMEOUT
  AUTH_ERROR
  VALIDATION_ERROR
}

enum SocialPlatform {
  INSTAGRAM
  FACEBOOK
  TIKTOK
  TWITTER_X
  LINKEDIN
  YOUTUBE
}

enum SocialConnectionType {
  MANAGED
  BYOA
}

enum PostType {
  IMAGE
  CAROUSEL
  VIDEO
  REEL
  STORY
  LIVE
  TEXT
  LINK
}

enum PostPerformance {
  TOP_PERFORMER
  ABOVE_AVERAGE
  AVERAGE
  BELOW_AVERAGE
  UNDERPERFORMING
}

enum AIPromptCategory {
  MONTHLY_SUMMARY
  WEEKLY_DIGEST
  METRIC_ANALYSIS
  TREND_DETECTION
  ANOMALY_ALERT
  RECOMMENDATION
  COMPARISON
  FORECAST
  REVIEW_RESPONSE
  CUSTOM
}

enum InsightPeriod {
  DAILY
  WEEKLY
  MONTHLY
  QUARTERLY
  YEARLY
  CUSTOM
}

enum InsightSentiment {
  POSITIVE
  NEUTRAL
  CAUTIONARY
  NEGATIVE
}

enum InsightUrgency {
  INFO
  LOW
  MEDIUM
  HIGH
  CRITICAL
}

enum InsightTrigger {
  SCHEDULED
  USER_REQUESTED
  ANOMALY
  THRESHOLD
}
